package com.vision.weatherapp.ui.screens\n\nimport androidx.compose.foundation.background\nimport androidx.compose.foundation.clickable\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.lazy.LazyColumn\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.foundation.shape.RoundedCornerShape\nimport androidx.compose.foundation.text.KeyboardActions\nimport androidx.compose.foundation.text.KeyboardOptions\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.filled.*\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clip\nimport androidx.compose.ui.graphics.Brush\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.platform.LocalFocusManager\nimport androidx.compose.ui.text.font.FontWeight\nimport androidx.compose.ui.text.input.ImeAction\nimport androidx.compose.ui.text.style.TextAlign\nimport androidx.compose.ui.unit.dp\nimport androidx.compose.ui.unit.sp\nimport androidx.lifecycle.compose.collectAsStateWithLifecycle\nimport androidx.lifecycle.viewmodel.compose.viewModel\nimport com.vision.weatherapp.data.model.GeocodingResult\nimport com.vision.weatherapp.ui.viewmodel.WeatherUiState\nimport com.vision.weatherapp.ui.viewmodel.WeatherViewModel\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun WeatherScreen(\n    viewModel: WeatherViewModel = viewModel()\n) {\n    val uiState by viewModel.uiState.collectAsStateWithLifecycle()\n    val focusManager = LocalFocusManager.current\n    \n    Scaffold(\n        topBar = {\n            TopAppBar(\n                title = { Text(\"Vision Weather\") },\n                colors = TopAppBarDefaults.topAppBarColors(\n                    containerColor = MaterialTheme.colorScheme.primary,\n                    titleContentColor = MaterialTheme.colorScheme.onPrimary\n                )\n            )\n        }\n    ) { paddingValues ->\n        Column(\n            modifier = Modifier\n                .fillMaxSize()\n                .padding(paddingValues)\n        ) {\n            // 搜索框\n            SearchBar(\n                query = uiState.searchQuery,\n                onQueryChange = { viewModel.searchCity(it) },\n                onSearch = { focusManager.clearFocus() },\n                active = uiState.searchResults.isNotEmpty(),\n                onActiveChange = { if (!it) viewModel.searchCity(\"\") },\n                placeholder = { Text(\"搜索城市...\") },\n                leadingIcon = { Icon(Icons.Default.Search, contentDescription = null) },\n                modifier = Modifier\n                    .fillMaxWidth()\n                    .padding(16.dp)\n            ) {\n                // 搜索结果列表\n                LazyColumn {\n                    items(uiState.searchResults) { result ->\n                        CitySearchItem(\n                            result = result,\n                            onClick = {\n                                viewModel.selectCity(result)\n                                focusManager.clearFocus()\n                            }\n                        )\n                    }\n                }\n            }\n            \n            // 天气内容\n            when {\n                uiState.isLoading -> {\n                    LoadingContent()\n                }\n                uiState.errorMessage != null -> {\n                    ErrorContent(\n                        message = uiState.errorMessage!!,\n                        onRetry = {\n                            uiState.weatherResponse?.let {\n                                viewModel.getWeather(it.latitude, it.longitude)\n                            }\n                        }\n                    )\n                }\n                uiState.weatherResponse != null -> {\n                    WeatherContent(\n                        uiState = uiState,\n                        onRefresh = {\n                            uiState.weatherResponse?.let {\n                                viewModel.getWeather(it.latitude, it.longitude)\n                            }\n                        }\n                    )\n                }\n                else -> {\n                    EmptyContent()\n                }\n            }\n        }\n    }\n}\n\n@Composable\nfun CitySearchItem(\n    result: GeocodingResult,\n    onClick: () -> Unit\n) {\n    ListItem(\n        headlineContent = { Text(result.name) },\n        supportingContent = { Text(\"${result.country} ${result.admin1 ?: \"\"}\") },\n        leadingContent = { Icon(Icons.Default.LocationOn, contentDescription = null) },\n        modifier = Modifier.clickable(onClick = onClick)\n    )\n}\n\n@Composable\nfun WeatherContent(\n    uiState: WeatherUiState,\n    onRefresh: () -> Unit\n) {\n    val weather = uiState.weatherResponse?.currentWeather ?: return\n    val cityName = uiState.searchQuery.ifBlank { \"当前位置\" }\n    \n    Column(\n        modifier = Modifier\n            .fillMaxSize()\n            .background(\n                Brush.verticalGradient(\n                    colors = listOf(\n                        MaterialTheme.colorScheme.primary.copy(alpha = 0.3f),\n                        MaterialTheme.colorScheme.background\n                    )\n                )\n            )\n            .padding(16.dp),\n        horizontalAlignment = Alignment.CenterHorizontally\n    ) {\n        // 城市名称\n        Text(\n            text = cityName,\n            fontSize = 28.sp,\n            fontWeight = FontWeight.Bold,\n            textAlign = TextAlign.Center\n        )\n        \n        Spacer(modifier = Modifier.height(8.dp))\n        \n        // 时间\n        Text(\n            text = weather.time,\n            fontSize = 14.sp,\n            color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)\n        )\n        \n        Spacer(modifier = Modifier.height(32.dp))\n        \n        // 温度\n        Text(\n            text = \"${weather.temperature.toInt()}°C\",\n            fontSize = 72.sp,\n            fontWeight = FontWeight.Light,\n            textAlign = TextAlign.Center\n        )\n        \n        Spacer(modifier = Modifier.height(16.dp))\n        \n        // 天气状况\n        Text(\n            text = getWeatherDescription(weather.weatherCode),\n            fontSize = 20.sp,\n            fontWeight = FontWeight.Medium\n        )\n        \n        Spacer(modifier = Modifier.height(32.dp))\n        \n        // 详细信息卡片\n        Card(\n            modifier = Modifier.fillMaxWidth(),\n            shape = RoundedCornerShape(16.dp)\n        ) {\n            Column(\n                modifier = Modifier.padding(16.dp)\n            ) {\n                WeatherDetailRow(\n                    icon = Icons.Default.Air,\n                    label = \"风速\",\n                    value = \"${weather.windSpeed.toInt()} km/h\"\n                )\n                HorizontalDivider(modifier = Modifier.padding(vertical = 8.dp))\n                WeatherDetailRow(\n                    icon = Icons.Default.Navigation,\n                    label = \"风向\",\n                    value = \"${getWindDirection(weather.windDirection)}\"\n                )\n                HorizontalDivider(modifier = Modifier.padding(vertical = 8.dp))\n                WeatherDetailRow(\n                    icon = Icons.Default.WbSunny,\n                    label = \"白天/夜晚\",\n                    value = if (weather.isDay == 1) \"白天\" else \"夜晚\"\n                )\n            }\n        }\n        \n        Spacer(modifier = Modifier.height(16.dp))\n        \n        // 刷新按钮\n        FilledTonalButton(\n            onClick = onRefresh\n        ) {\n            Icon(Icons.Default.Refresh, contentDescription = null)\n            Spacer(modifier = Modifier.width(8.dp))\n            Text(\"刷新\")\n        }\n    }\n}\n\n@Composable\nfun WeatherDetailRow(\n    icon: androidx.compose.ui.graphics.vector.ImageVector,\n    label: String,\n    value: String\n) {\n    Row(\n        modifier = Modifier.fillMaxWidth(),\n        verticalAlignment = Alignment.CenterVertically\n    ) {\n        Icon(\n            imageVector = icon,\n            contentDescription = null,\n            tint = MaterialTheme.colorScheme.primary,\n            modifier = Modifier.size(24.dp)\n        )\n        Spacer(modifier = Modifier.width(12.dp))\n        Text(\n            text = label,\n            fontSize = 16.sp,\n            modifier = Modifier.weight(1f)\n        )\n        Text(\n            text = value,\n            fontSize = 16.sp,\n            fontWeight = FontWeight.Medium\n        )\n    }\n}\n\n@Composable\nfun LoadingContent() {\n    Box(\n        modifier = Modifier.fillMaxSize(),\n        contentAlignment = Alignment.Center\n    ) {\n        Column(\n            horizontalAlignment = Alignment.CenterHorizontally\n        ) {\n            CircularProgressIndicator()\n            Spacer(modifier = Modifier.height(16.dp))\n            Text(\"加载天气中...\")\n        }\n    }\n}\n\n@Composable\nfun ErrorContent(\n    message: String,\n    onRetry: () -> Unit\n) {\n    Box(\n        modifier = Modifier.fillMaxSize(),\n        contentAlignment = Alignment.Center\n    ) {\n        Column(\n            horizontalAlignment = Alignment.CenterHorizontally,\n            modifier = Modifier.padding(16.dp)\n        ) {\n            Icon(\n                imageVector = Icons.Default.Error,\n                contentDescription = null,\n                tint = MaterialTheme.colorScheme.error,\n                modifier = Modifier.size(64.dp)\n            )\n            Spacer(modifier = Modifier.height(16.dp))\n            Text(\n                text = \"获取天气失败\",\n                fontSize = 20.sp,\n                fontWeight = FontWeight.Bold\n            )\n            Spacer(modifier = Modifier.height(8.dp))\n            Text(\n                text = message,\n                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)\n            )\n            Spacer(modifier = Modifier.height(16.dp))\n            Button(onClick = onRetry) {\n                Text(\"重试\")\n            }\n        }\n    }\n}\n\n@Composable\nfun EmptyContent() {\n    Box(\n        modifier = Modifier.fillMaxSize(),\n        contentAlignment = Alignment.Center\n    ) {\n        Column(\n            horizontalAlignment = Alignment.CenterHorizontally,\n            modifier = Modifier.padding(16.dp)\n        ) {\n            Icon(\n                imageVector = Icons.Default.Search,\n                contentDescription = null,\n                tint = MaterialTheme.colorScheme.primary.copy(alpha = 0.5f),\n                modifier = Modifier.size(64.dp)\n            )\n            Spacer(modifier = Modifier.height(16.dp))\n            Text(\n                text = \"搜索城市查看天气\",\n                fontSize = 18.sp,\n                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f)\n            )\n        }\n    }\n}\n\n/**\n * 根据天气代码获取天气描述\n */\nfun getWeatherDescription(code: Int): String {\n    return when (code) {\n        0 -> \"晴朗\"\n        1, 2, 3 -> \"多云\"\n        45, 48 -> \"雾\"\n        51, 53, 55 -> \"小到中雨\"\n        56, 57 -> \"冻雨\"\n        61, 63, 65 -> \"雨\"\n        66, 67 -> \"冻雨\"\n        71, 73, 75 -> \"雪\"\n        77 -> \"阵雪\"\n        80, 81, 82 -> \"阵雨\"\n        85, 86 -> \"阵雪\"\n        95 -> \"雷暴\"\n        96, 99 -> \"雷暴+冰雹\"\n        else -> \"未知\"\n    }\n}\n\n/**\n * 将风向角度转换为文字描述\n */\nfun getWindDirection(degrees: Double): String {\n    val directions = listOf(\"北\", \"东北\", \"东\", \"东南\", \"南\", \"西南\", \"西\", \"西北\")\n    val index = ((degrees + 22.5) / 45).toInt() % 8\n    return directions[index]\n}\n